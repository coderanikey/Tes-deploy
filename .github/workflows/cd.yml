name: React Docker CI/CD

on:
  push:
    branches:
      - main

permissions:
  contents: read

env:
  DOCKERHUB_USERNAME: anikri
  IMAGE_NAME: aniket
  AZURE_WEBAPP_NAME: qni
  AZURE_RESOURCE_GROUP: <YOUR_RESOURCE_GROUP>

jobs:
  build-push-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ Get short commit SHA
      - name: Get Commit SHA
        run: echo "COMMIT_SHA=$(git rev-parse --short HEAD)" >> $GITHUB_ENV

      # 3Ô∏è‚É£ Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      # 4Ô∏è‚É£ Install dependencies & build React app
      - name: Install and Build React
        run: |
          npm install
          npm run build

      # 5Ô∏è‚É£ Login to Docker Hub
      - name: Docker Hub Login
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 6Ô∏è‚É£ Build Docker image (latest + commit SHA)
      - name: Build Docker Image
        run: |
          docker build \
            -t $DOCKERHUB_USERNAME/$IMAGE_NAME:latest \
            -t $DOCKERHUB_USERNAME/$IMAGE_NAME:${{ env.COMMIT_SHA }} .

      # 7Ô∏è‚É£ Push Docker images to Docker Hub
      - name: Push Docker Image
        run: |
          docker push $DOCKERHUB_USERNAME/$IMAGE_NAME:latest
          docker push $DOCKERHUB_USERNAME/$IMAGE_NAME:${{ env.COMMIT_SHA }}

      # 8Ô∏è‚É£ Azure Login (required for az cli)
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # 9Ô∏è‚É£ Configure Azure Web App to use Docker image (CRITICAL)
      - name: Configure Azure Web App Container
        uses: azure/cli@v2
        with:
          inlineScript: |
            az webapp config container set \
              --name $AZURE_WEBAPP_NAME \
              --resource-group $AZURE_RESOURCE_GROUP \
              --docker-custom-image-name docker.io/$DOCKERHUB_USERNAME/$IMAGE_NAME:latest \
              --docker-registry-server-url https://index.docker.io

      # üîü Restart Web App so it pulls latest image
      - name: Restart Azure Web App
        uses: azure/cli@v2
        with:
          inlineScript: |
            az webapp restart \
              --name $AZURE_WEBAPP_NAME \
              --resource-group $AZURE_RESOURCE_GROUP
